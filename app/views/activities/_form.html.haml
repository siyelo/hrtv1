- fiscal_year_prev = fiscal_year_prev(@response)
- fiscal_year = fiscal_year(@response)

:javascript
  var _response_id = "#{@response.id}";
  var _activity_id = "#{@activity.id}";
  var _funding_sources = #{get_funding_sources(current_user.organization.projects)}
  var _budget = #{@response.data_request.budget.to_json};
  var _spend = #{@response.data_request.spend.to_json};

- f.inputs :class => 'inputs' do
  %li.last
    %h3 Basics
    %ul.dashboard_section
      = f.input :project_id, :label => "Project", :as => :select, :collection => current_user.current_data_response ? current_user.current_data_response.projects : [@activity.try(:project).try(:data_response).try(:projects)].flatten, :hint => "The Project this activity correlates to"

      #project_sub_form
        #project_sub_form_fields
          - if @activity.project
            = render 'project_sub_form', {:activity => @activity, :project => @activity.project}

      = f.input :name, :required => false, :hint => "The name of this Activity."
      = f.input :description, :input_html => { :rows => 2 }, :required => false, :hint => "A description of this Activity."
      = f.input :start_date, :as => :string, :label => "Start date", :input_html => {:class => 'date_picker'}, :hint => "(YYYY-MM-DD) When the Project (and it's related Activities) started.", :required => false
      = f.input :end_date, :as => :string, :label => "End date", :input_html => {:class => 'date_picker'}, :hint => "(YYYY-MM-DD) The end date for the Projectâ€™s implementation.", :required => false


  - if @response.data_request.spend?
    %li.last
      %h3== Past Activity Expenditure (#{@response.currency})
      %ul.dashboard_section
        = f.input :spend, :label => "Spent", :hint => "The total amount that you have spent in the past fiscal year. You can enter the total amount here OR below in the quarterly fields", :required => false
        %li.amounts.last
          %label== Quarterly spend
          %ul
            = f.input :spend_q4_prev, :label => "Q4 #{fiscal_year_prev}", :required => false
            = f.input :spend_q1     , :label => "Q1 #{fiscal_year}", :required => false
            = f.input :spend_q2     , :label => "Q2 #{fiscal_year}", :required => false
            = f.input :spend_q3     , :label => "Q3 #{fiscal_year}", :required => false
            = f.input :spend_q4     , :label => "Q4 #{fiscal_year}", :required => false

  - if @response.data_request.budget?
    %li.last
      %h3 Budget (planned expenditure) (#{@response.currency})
      %ul.dashboard_section
        = f.input :budget, :label => "Budget", :hint => "The total amount that you are planning to spend in the upcoming fiscal year. You can enter the total amount here OR below in the quarterly fields", :required => false
        %li.amounts.last
          %label== Quarterly budget
          %ul
            = f.input :budget_q4_prev, :label => "Q4 #{fiscal_year_prev}", :required => false
            = f.input :budget_q1     , :label => "Q1 #{fiscal_year}", :required => false
            = f.input :budget_q2     , :label => "Q2 #{fiscal_year}", :required => false
            = f.input :budget_q3     , :label => "Q3 #{fiscal_year}", :required => false
            = f.input :budget_q4     , :label => "Q4 #{fiscal_year}", :required => false
        %li.amounts
          %label Long-term
          %ul
            = f.input :budget2, :label => "Year + 2", :required => false if @response.request.year_2?
            = f.input :budget3, :label => "Year + 3", :required => false if @response.request.year_3?
            = f.input :budget4, :label => "Year + 4", :required => false if @response.request.year_4?
            = f.input :budget5, :label => "Year + 5", :required => false if @response.request.year_5?

  %li.last
    %h3 Activity Funding Sources
    %ul.dashboard_section
      .funding_sources
        - f.semantic_fields_for :funding_sources do |fs|
          = render "activities/funding_source_fields", :f => fs
        .add
          = link_to_add_fields "Add funding source", f, :funding_sources, "activities/"
          %p.hint The sources from which your organization receives funding for this Activity.
        

  %li.last
    %h3== Implementers
    %ul.dashboard_section
      %p.hint Service Providers and partners you work with
      - hint = "Service Providers who implement Activities for your organization's Projects/Activities. E.g. a NGO, a Health Facility Institution, Government office, or a District."
      - hint = hint + "<br>NOTE: You uploaded \"#{@activity.text_for_provider}\"" if !@activity.text_for_provider.blank? && @activity.provider.nil?
      = f.input :provider, :label => "Implementer", :as => :select, :collection => Organization.find(:all, :order => 'old_type, name'), :hint => hint, :required => false, :input_html => {:class => 'implementer_select'}
      = render :partial => 'shared/add_organizations'
      
  %li.last.sub_activities
    %h3 Sub Activities
    %p.hint Optional. Used if you fund a large number of different partners (for example, 20 health centers in a number of locations), that implement identical or very similar Activities.
    - f.semantic_fields_for :sub_activities do |ca|
      = render "activities/sub_activity_fields", :f => ca
    .add
      = link_to_add_fields "Add Sub Activity", f, :sub_activities, "activities/"

  %li.last
    %h3== Other
    %ul.dashboard_section
      = f.input :beneficiaries, :as => :check_boxes, :label => "Beneficiary details / Other beneficiaries", :hint => "Beneficiaries of your Activity, if applicable to any of these population groups."
      = f.input :text_for_beneficiaries, :input_html => { :rows => 2 }, :label => "Other beneficiaries", :as => :text, :required => false, :hint => "Beneficiaries of your Activity that are not listed above."
      = f.input :text_for_targets, :input_html => { :rows => 2 }, :label => "Targets", :as => :text, :required => false, :hint => "The goals of this Activity."

  %li
    %ul.horizontal
      - f.buttons :class => 'buttons' do
        = f.commit_button "Save", :class => "last"
        - if @response.data_request.spend? || @response.data_request.budget?
          = f.commit_button "Save & Classify >", :class => "last"

- unless @activity.new_record?
  .delete_section
    = link_to "Delete this Activity", response_activity_path(@response, @activity), :confirm => "Are you sure you want to delete this Activity?", :method => :delete, :class => "delete_btn", :class => 'delete_action'
    %p
      %strong Warning:
      Once you delete an Activity, you will lose all data associated with it, and there is no undo.
